import org.bonitasoft.engine.gradle.ShadeDependency

plugins { id 'bonita-shade' }

dependencies {
    // import jackson bom to align jackson dependencies even when resolving shade dependencies
    // When create the shade version of bonita-server, the bonita-common project is excluded causing the jackson bom not to be imported
    // This cause issues to the code deposit because an different version of jackson, that was not downloaded to local cache, can be required during offline build.
    // Remove the shade to solve that issue
    implementation(platform("com.fasterxml.jackson:jackson-bom:${Deps.jacksonDataBindingVersion}"))
    compile project(':bpm:bonita-core:bonita-process-engine')
    compile project(':services:bonita-builder')
    compile project(':bpm:bonita-core:bonita-actor-mapping')
    compile project(':bpm:bonita-api:bonita-server-api-http')
    compile project(':services:bonita-archive')
    compile project(':services:bonita-authentication')
    compile project(':services:bonita-business-application')
    compile project(':services:bonita-business-data:bonita-business-data-impl')
    compile project(':services:bonita-business-data:bonita-business-data-client-resources')
    compile project(':services:bonita-business-data:bonita-business-data-generator')
    compile project(':services:bonita-cache')
    compile project(':bpm:bonita-core:bonita-category')
    compile project(':services:bonita-classloader')
    compile project(':services:bonita-command')
    compile project(':bpm:bonita-core:bonita-contract-data')
    compile project(':services:bonita-connector-executor')
    compile project(':services:bonita-data-definition')
    compile project(':services:bonita-data-instance')
    compile project(':services:bonita-events')
    compile project(':services:bonita-expression')
    compile project(':services:bonita-external-identity-mapping')
    compile project(':bpm:bonita-core:bonita-form-mapping')
    compile project(':services:bonita-incident')
    compile project(':services:bonita-identity')
    compile project(':services:bonita-lock')
    compile project(':bpm:bonita-core:bonita-login')
    compile project(':services:bonita-log')
    compile project(':services:bonita-page')
    compile project(':bpm:bonita-core:bonita-parameter')
    compile project(':services:bonita-persistence')
    compile project(':services:bonita-platform')
    compile project(':services:bonita-platform-authentication')
    compile project(':services:bonita-platform-command')
    compile project(':bpm:bonita-core:bonita-platform-login')
    compile project(':services:bonita-platform-session')
    compile project(':bpm:bonita-core:bonita-process-comment')
    compile project(':bpm:bonita-core:bonita-process-definition')
    compile project(':bpm:bonita-core:bonita-process-instance')
    compile project(':services:bonita-scheduler')
    compile project(':services:bonita-session')
    compile project(':bpm:bonita-core:bonita-supervisor-mapping')
    compile project(':bpm:bonita-synchro-repository:bonita-synchro-service')
    compile project(':bpm:bonita-synchro-repository:bonita-synchro-service-impl')
    compile project(':bpm:bonita-synchro-repository:bonita-synchro-register')
    compile project(':services:bonita-time-tracker')
    compile project(':services:bonita-transaction')
    compile project(':bpm:bonita-core:bonita-core-data')
    compile project(':bpm:bonita-core:bonita-user-filter')
    compile project(':services:bonita-work')
    compile project(':bpm:bonita-external')
    compile project(':services:bonita-profile')
    compile project(':bpm:bonita-common')
}

shade {
    exclude project(':bpm:bonita-common')
    exclude project(':platform:platform-resources')

    excludeLibs('hibernate-core',
            new ShadeDependency(group: 'org.jboss.spec.javax.transaction', name: 'jboss-transaction-api_1.2_spec'),
            new ShadeDependency(group: 'javax.activation', name: 'javax.activation-api')
    )
    excludeLibs('jaxb-api',
            new ShadeDependency(group: 'javax.activation', name: 'javax.activation-api'))
    excludeLibs('jaxb-runtime',
            new ShadeDependency(group: 'javax.activation', name: 'javax.activation-api'))
    excludeLibs('quartz',
            new ShadeDependency(group: 'com.mchange', name: '*'),
            new ShadeDependency(group: 'com.zaxxer', name: 'HikariCP-java7'))
}

afterEvaluate {
    publishing {
        publications {
            shadow(MavenPublication) { publication ->
                publication.getPom().with {
                    name = "Bonita Server"
                    description = "Bonita Server is the Server-side BPM Execution Engine"
                }
            }
        }
    }
}
